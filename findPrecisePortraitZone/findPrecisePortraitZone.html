<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://npm.scannerproxy.com:802/cdn/@dynamsoft/dynamsoft-capture-vision-bundle@3.4.1000-dev-20260115162916/dist/dcv.bundle.js"></script>
</head>

<body>
  <button class="startCapturing">start capturing</button>
  <input type="file" class="captureImage" />
  <div class="div-ui-container" style="width: 100%; height: 80vh; margin-top: 10px;display: none;"></div>
  <div class="portrait-zone" style="margin-top: 10px;"></div>

  <script>
    const uiContainer = document.querySelector(".div-ui-container");
    const portraitZoneContainer = document.querySelector(".portrait-zone");

    Dynamsoft.Core.CoreModule.engineResourcePaths = {
      dcvData: 'https://npm.scannerproxy.com:802/cdn/@dynamsoft/dynamsoft-capture-vision-data@1.2.0-dev-20260115155836/',
    }
    Dynamsoft.License.LicenseManager.initLicense("DLS2eyJoYW5kc2hha2VDb2RlIjoiODAwMC04MDAwIiwibWFpblNlcnZlclVSTCI6Imh0dHBzOi8vMTkyLjE2OC44LjEyMi9kbHMvIiwib3JnYW5pemF0aW9uSUQiOiI4MDAwIiwiY2hlY2tDb2RlIjotMTA1NjUzOTM3M30=", { executeNow: true });

    let view, dce, cvr;
    let pInit = (async function init() {
      cvr = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
      view = await Dynamsoft.DCE.CameraView.createInstance();
      dce = await Dynamsoft.DCE.CameraEnhancer.createInstance(view);
      dce._imageDataGetter.useWebGLByDefault = false;
      dce.setPixelFormat(10);

      cvr.setInput(dce);
      await cvr.initSettings("./findPrecisePortraitZone.json");

      let crr = new Dynamsoft.CVR.CapturedResultReceiver();
      crr.onCapturedResultReceived = async (pResult) => {
        cvr.stopCapturing();
        const oriImg = pResult.items.filter(item => item.type === 1)[0];
        const quad = await Dynamsoft.IdentityUtility.IdentityProcessor.findPrecisePortraitZone();
        console.log("findPrecisePortraitZone: ", quad);
        if (!quad.errorCode) {
          const croppedImage = await Dynamsoft.Utility.ImageProcessor.cropAndDeskewImage(oriImg.imageData, quad);
          console.log("croppedImage: ", croppedImage);
          portraitZoneContainer.innerHTML = "";
          portraitZoneContainer.append(Dynamsoft.Core._toCanvas(croppedImage));
          view.clearAllInnerDrawingItems();
          uiContainer.style.display = "none";
        } else {
          cvr.startCapturing("ReadPassportAndId");
        }
      }
      await cvr.addResultReceiver(crr);

      uiContainer.append(view.getUIElement());
    })();

    document.querySelector(".startCapturing").addEventListener("click", async () => {
      await pInit;
      uiContainer.style.display = "block";
      await dce.open();
      await cvr.startCapturing("ReadPassportAndId");
    });

    document.querySelector(".captureImage").addEventListener("change", async (e) => {
      await pInit;
      const result = await cvr.capture(e.target.files[0], "ReadPassportAndId");
      console.log(result);
      const quad = await Dynamsoft.IdentityUtility.IdentityProcessor.findPrecisePortraitZone();
      console.log("findPrecisePortraitZone: ", quad);
      const croppedImage = await Dynamsoft.Utility.ImageProcessor.cropAndDeskewImage(e.target.files[0], quad);
      console.log("croppedImage: ", croppedImage);
      portraitZoneContainer.innerHTML = "";
      portraitZoneContainer.append(Dynamsoft.Core._toCanvas(croppedImage));
    });
  </script>
</body>

</html>